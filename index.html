<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bagvoyage</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="img/bagvoyage-icon-32.png">

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="img/bagvoyage-icon-180.png">

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Theme Colors -->
  <meta name="theme-color" content="#1aa3ff">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>


  <!-- Fonts & ZXing -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <style>
    :root{
      --bg:#0b1220; --surface:#0f1b33; --card:#101a2e; --outline:#1f2a44;
      --text:#e7eefc; --muted:#9fb0d0;
      --primary:#1aa3ff;  /* brand primary */
      --ok:#00cc88;       /* success */
      --bad:#ff4f5e;      /* alert */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;display:grid;place-items:center}
    .app{width:min(980px,100%);height:min(680px,100vh);background:var(--card);border:1px solid var(--outline);border-radius:20px;overflow:hidden;display:flex;flex-direction:column}
    .hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--outline);font-weight:800}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img,.brand svg{width:22px;height:22px}
    .hdr .right{display:flex;gap:8px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--outline);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#9ca3af}
    .dot.ok{background:var(--ok)}
    .main{flex:1;display:grid;grid-template-columns:1fr;grid-template-rows:1fr}

    /* Home */
    .home{display:grid;place-items:center;padding:24px}
    .home .stack{display:flex;flex-direction:column;gap:12px;width:min(420px,92%)}
    .btn{appearance:none;border:0;border-radius:16px;padding:16px 18px;font-weight:800;cursor:pointer;font-size:16px}
    .btn.primary{background:var(--primary);color:#001421}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--outline)}

    /* Scanner */
    .scan{position:relative;background:#000;display:grid;grid-template-rows:auto 1fr auto}
    .scan video{width:100%;height:100%;object-fit:cover}
    .toolbar{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--outline);background:linear-gradient(180deg,rgba(15,27,51,.9),rgba(15,27,51,.75))}
    .toolbar .title{font-weight:800}
    .toolbar .spacer{flex:1}
    .toolbar .btn{padding:10px 12px;border-radius:12px}

    .frame{pointer-events:none}
    .corn{position:absolute;width:34px;height:34px;border:3px solid rgba(255,255,255,.9);opacity:.9}
    .tl{left:10%;top:14%;border-right:none;border-bottom:none;border-radius:6px 0 0 0}
    .tr{right:10%;top:14%;border-left:none;border-bottom:none;border-radius:0 6px 0 0}
    .bl{left:10%;bottom:14%;border-right:none;border-top:none;border-radius:0 0 0 6px}
    .br{right:10%;bottom:14%;border-left:none;border-top:none;border-radius:0 0 6px 0}
    .line{position:absolute;left:12%;right:12%;top:16%;height:2px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.95),transparent);box-shadow:0 0 18px rgba(255,255,255,.8);animation:sweep 2.2s linear infinite}
    @keyframes sweep{from{transform:translateY(0)}to{transform:translateY(58vh)}}

    /* Sheets & toasts */
    .sheet{position:absolute;inset:auto 0 0 0;background:rgba(15,27,51,.96);border-top-left-radius:18px;border-top-right-radius:18px;padding:16px 16px 18px;border-top:1px solid var(--outline);transform:translateY(110%);transition:transform .22s ease;z-index:5}
    .sheet.show{transform:translateY(0)}
    .sheet .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{display:inline-block;padding:8px 12px;border-radius:999px;font-weight:800}
    .pill.ok{background:rgba(0,204,136,.15);color:#b8ffe8;border:1px solid rgba(0,204,136,.35)}
    .pill.bad{background:rgba(255,79,94,.15);color:#ffc2c7;border:1px solid rgba(255,79,94,.35)}
    .toast{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(16,26,46,.98);border:1px solid var(--outline);padding:10px 12px;border-radius:12px;font-weight:700;opacity:0;transition:opacity .18s ease;z-index:6}
    .toast.show{opacity:1}

    /* Dialog */
    dialog{border:1px solid var(--outline);border-radius:16px;background:var(--card);color:var(--text);padding:16px;max-width:420px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    input[type=text]{width:100%;padding:12px 14px;background:var(--surface);border:1px solid var(--outline);border-radius:12px;color:var(--text);font-weight:600}

    /* Splash */
    #splash{position:fixed;inset:0;display:grid;place-items:center;
      background: radial-gradient(800px 600px at 30% 20%, rgba(26,163,255,.25), transparent 40%), #0b1220;
      z-index:9999; transition:opacity .25s ease}
    #splash.hidden{opacity:0;pointer-events:none}
    #splash .wrap{text-align:center}
    #splash img{width:72px;height:72px;display:block;margin:0 auto 12px}
    #splash h1{margin:0;font-size:20px;letter-spacing:.5px}

    .hidden{display:none !important}
  </style>
</head>
<script>

  // Basic normalization for baggage tags (keeps numeric payloads common in IATA tags)
function normalizeBaggageCode(s){
  if(!s) return '';
  const digits = (s.match(/\d+/g) || []).join('');
  // Typical: 10-digit license plate, sometimes 13 with airline prefix
  if (digits.length === 10 || digits.length === 13) return digits;
  // Otherwise allow plausible ranges during testing
  return (digits.length >= 8 && digits.length <= 20) ? digits : '';
}

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>

<body>
  <!-- Splash (inside body) -->
  <div id="splash">
    <div class="wrap">
      <img src="img/bagvoyage-icon-192.png" alt="Bagvoyage logo" />
      <h1>Bagvoyage</h1>
    </div>
  </div>

  <div class="app" role="application" aria-label="Bagvoyage">
    <div class="hdr">
      <div class="brand">
        <!-- Inline fallback logo (simple suitcase + check) -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <rect x="5" y="7" width="14" height="12" rx="2" ry="2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M8 13l2.2 2.2L16 9.5" fill="none" stroke="#00cc88" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Bagvoyage</span>
      </div>
      <div class="right">
        <span class="chip"><span id="dbDot" class="dot"></span><span id="dbLabel">DB: checking…</span></span>
        <span class="chip"><span id="camDot" class="dot"></span><span id="camLabel">Camera: idle</span></span>
      </div>
    </div>

    <div id="home" class="main home">
      <div class="stack">
        <button id="btnTag" class="btn primary">Tag — Start scanning</button>
        <button id="btnRetrieve" class="btn ghost">Retrieve — Scan to verify</button>
        <button id="btnManual" class="btn ghost">Manual entry</button>
      </div>
    </div>

    <div id="scan" class="main scan hidden" aria-live="polite">
      <div class="toolbar">
        <div class="title" id="modeTitle">Mode</div>
        <div class="spacer"></div>
        <button id="btnTorch" class="btn ghost" title="Toggle torch">Torch</button>
        <button id="btnStop" class="btn ghost" title="Exit scanning">Exit</button>
      </div>
      <video id="preview" muted playsinline></video>
      <div class="frame">
        <div class="corn tl"></div><div class="corn tr"></div><div class="corn bl"></div><div class="corn br"></div>
        <div class="line"></div>
      </div>
      <div id="sheet" class="sheet" aria-atomic="true">
        <div class="row">
          <span id="pill" class="pill">STATE</span>
          <button id="btnContinue" class="btn primary hidden">Continue</button>
        </div>
        <div style="margin:8px 0 6px;font-weight:800;font-size:18px" id="sheetTitle">Result</div>
        <div style="font-family:ui-monospace,Menlo,Consolas,monospace" id="sheetCode"></div>
      </div>
      <div id="toast" class="toast">Saved</div>
    </div>
  </div>

  <!-- Manual entry -->
  <dialog id="manualDialog">
    <form method="dialog">
      <div style="font-weight:800;margin-bottom:8px">Manual entry</div>
      <input id="manualInput" type="text" placeholder="Enter code"/>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" value="cancel">Cancel</button>
        <button id="manualApply" class="btn primary" value="ok">Apply</button>
      </div>
    </form>
  </dialog>

  <script>
    // Hide splash when app is ready
    window.addEventListener('load', () => {
      setTimeout(() => document.getElementById('splash').classList.add('hidden'), 250);
    });

    (function init(){
      if(window.__BAGVOYAGE_LOADED__){ console.warn('Bagvoyage already loaded.'); return; }
      window.__BAGVOYAGE_LOADED__ = true;

      const { BrowserMultiFormatReader } = ZXingBrowser;
      const reader = new BrowserMultiFormatReader();

      // One-time migration: baggage_tags -> bagvoyage_tags
      const OLD_KEY = 'baggage_tags';
      const NEW_KEY = 'bagvoyage_tags';
      (function migrate(){
        try{
          const hasNew = localStorage.getItem(NEW_KEY);
          const old = localStorage.getItem(OLD_KEY);
          if(!hasNew && old){
            localStorage.setItem(NEW_KEY, old);
            localStorage.setItem('bagvoyage_migrated', String(Date.now()));
            console.log('[Bagvoyage] Migrated local data from', OLD_KEY, 'to', NEW_KEY);
          }
        }catch(e){}
      })();

      // State
      let isScanning = false;
      let mode = null; // 'tag' | 'retrieve'
      let lastRead = { code:null, ts:0 };
      let currentTrack = null; // for torch

      // Local DB
      const DB = NEW_KEY;
      const getAll = () => { try{return JSON.parse(localStorage.getItem(DB)||'[]')}catch{return[]} };
      const saveTag = code => { const a=getAll(); a.unshift({code,ts:Date.now()}); localStorage.setItem(DB, JSON.stringify(a)); };
      const exists  = code => getAll().some(x=>x.code===code);

      // DOM
      const $home = document.getElementById('home');
      const $scan = document.getElementById('scan');
      const $title = document.getElementById('modeTitle');
      const $video = document.getElementById('preview');
      const $sheet = document.getElementById('sheet');
      const $pill = document.getElementById('pill');
      const $sheetTitle = document.getElementById('sheetTitle');
      const $sheetCode = document.getElementById('sheetCode');
      const $btnContinue = document.getElementById('btnContinue');
      const $toast = document.getElementById('toast');
      const $dbDot = document.getElementById('dbDot');
      const $dbLabel = document.getElementById('dbLabel');
      const $camDot = document.getElementById('camDot');
      const $camLabel = document.getElementById('camLabel');
      const $manualDlg = document.getElementById('manualDialog');
      const $manualInput = document.getElementById('manualInput');

      // status
      setTimeout(()=>{ $dbDot.className='dot ok'; $dbLabel.textContent='DB: online (local demo)'; }, 300);

      const vibrate = p => { try{ navigator.vibrate && navigator.vibrate(p) }catch{} };
      const toast = (msg, ms=800) => { $toast.textContent=msg; $toast.classList.add('show'); setTimeout(()=>$toast.classList.remove('show'), ms); };
      const openSheet = (kind, title, code, wait) => {
        $pill.className = 'pill ' + (kind==='ok'?'ok':'bad');
        $pill.textContent = kind==='ok' ? 'MATCH' : 'UNMATCHED';
        $sheetTitle.textContent = title;
        $sheetCode.textContent = code;
        if (wait) { $btnContinue.classList.remove('hidden'); }
        else { $btnContinue.classList.add('hidden'); }
        $sheet.classList.add('show');
        if (!wait) setTimeout(()=> $sheet.classList.remove('show'), 900);
      };

      function showHome(){ $scan.classList.add('hidden'); $home.classList.remove('hidden'); mode=null; setCamStatus(false); }
      function showScan(m){ mode=m; $title.textContent = m==='tag'?'Tag — scanning':'Retrieve — scan to verify'; $home.classList.add('hidden'); $scan.classList.remove('hidden'); }

     async function startScan(m){
  if(isScanning) return;
  showScan(m);
  isScanning = true;
  setCamStatus(true);

  try{
    // Safely resolve ZXing namespace/enums across versions
    const ZXB = (window.ZXingBrowser) || {};
    const BrowserMultiFormatReader = ZXB.BrowserMultiFormatReader;
    const BarcodeFormat = ZXB.BarcodeFormat || (ZXB.ZXing && ZXB.ZXing.BarcodeFormat);
    const DecodeHintType = ZXB.DecodeHintType || (ZXB.ZXing && ZXB.ZXing.DecodeHintType);

    // Build hints only if enums exist (prevents "TRY_HARDER" crash)
    let hints;
    if (DecodeHintType && BarcodeFormat) {
      hints = new Map();
      hints.set(DecodeHintType.TRY_HARDER, true);
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [
        BarcodeFormat.ITF,          // Interleaved 2 of 5 (IATA)
        BarcodeFormat.CODE_128,
        BarcodeFormat.PDF_417,
        BarcodeFormat.DATA_MATRIX,
        BarcodeFormat.QR_CODE,
        BarcodeFormat.CODE_39,
        BarcodeFormat.EAN_13,
        BarcodeFormat.EAN_8,
        BarcodeFormat.UPC_A,
        BarcodeFormat.AZTEC
      ].filter(Boolean)); // filter in case any enum is missing
    }

    // Prefer back camera + decent resolution
    const constraints = {
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    };

    // Try with hints; if it throws on some devices, retry without hints
    const tryDecode = (useHints=true) =>
      ZXB.decodeFromConstraints
        ? ZXB.decodeFromConstraints(constraints, $video, onResult, useHints ? hints : undefined)
        : reader.decodeFromConstraints(constraints, $video, onResult, useHints ? hints : undefined);

    const reader = new BrowserMultiFormatReader();

    const onResult = (result, err) => {
      if(!isScanning) return;
      if (result) {
        const raw = result.getText();
        const norm = normalizeBaggageCode(raw);
        onScan(norm || raw);
      }
      // ignore NotFound noise
    };

    try {
      await reader.decodeFromConstraints(constraints, $video, onResult, hints);
    } catch (e) {
      console.warn('[Bagvoyage] decode with hints failed, retrying without hints:', e);
      await reader.decodeFromConstraints(constraints, $video, onResult); // no hints fallback
    }

    // Cache track for torch control
    const stream = $video.srcObject;
    currentTrack = stream && stream.getVideoTracks ? stream.getVideoTracks()[0] : null;

  }catch(e){
    alert('Camera access failed: ' + e.message);
    setCamStatus(false);
    isScanning = false;
    showHome();
  }
}

      // Torch toggle (when supported)
      document.getElementById('btnTorch').addEventListener('click', async ()=>{
        if(!currentTrack) return;
        try{
          const caps = currentTrack.getCapabilities && currentTrack.getCapabilities();
          if(caps && caps.torch){
            const settings = currentTrack.getSettings();
            const next = !settings.torch;
            await currentTrack.applyConstraints({ advanced:[{ torch: next }] });
          }else{
            toast('Torch not supported', 1000);
          }
        }catch{ toast('Torch control failed', 1000); }
      });

      // Continue & Exit
      $btnContinue.addEventListener('click', ()=>{
        $sheet.classList.remove('show');
        startScan('retrieve'); // resume same mode
      });
      document.getElementById('btnStop').addEventListener('click', ()=>{
        stopScan();
        showHome();
      });

      // Home buttons
      document.getElementById('btnTag').addEventListener('click', ()=> startScan('tag'));
      document.getElementById('btnRetrieve').addEventListener('click', ()=> startScan('retrieve'));

      // Manual entry dialog
      document.getElementById('btnManual').addEventListener('click', ()=> { $manualInput.value=''; $manualDlg.showModal(); });
      document.getElementById('manualApply').addEventListener('click', (e)=>{
        e.preventDefault();
        const v = ($manualInput.value||'').trim();
        if(!v) return;
        if(!mode || mode==='tag'){ saveTag(v); toast('Saved'); }
        else { exists(v) ? (stopScan(), openSheet('ok','MATCH',v,true)) : openSheet('bad','UNMATCHED',v,false); }
        $manualDlg.close();
      });

      // Optional service worker
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('sw.js').catch(()=>{/* ignore */});
      }
    })();
  </script>
</body>
</html>
