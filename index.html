<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bagvoyage</title>

  <!-- Icons / PWA -->
  <link rel="icon" type="image/png" sizes="32x32" href="img/bagvoyage-icon-32.png" />
  <link rel="apple-touch-icon" href="img/bagvoyage-icon-180.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Theme Colors -->
  <meta name="theme-color" content="#1aa3ff" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Fonts & ZXing -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <!-- App CSS -->
  <link rel="stylesheet" href="style.css" />

  <script>
    // Register SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('SW registered'))
        .catch(err => console.warn('SW registration failed', err));
    }

    // ---------- Helpers ----------
    function extractDigits(s){ return (s && s.match(/\d+/g)) ? s.match(/\d+/g).join('') : ''; }
    function normalizeBaggageCode(s){
      const d = extractDigits(s);
      return (d.length === 10 || d.length === 13) ? d : '';
    }
    // Split-label assembly (combine two Code128 halves within 1s)
    const FRAG_WINDOW_MS = 1000;
    let fragBuffer = []; // {digits, ts}
    function addFragment(d){ 
      const now=Date.now(); 
      fragBuffer.push({digits:d, ts:now});
      // Cap buffer at 10 items to prevent memory issues
      fragBuffer = fragBuffer.slice(-10).filter((f,i,a)=> now-f.ts<=FRAG_WINDOW_MS && (i===0 || f.digits!==a[i-1].digits)); 
    }
    function tryAssemble(){
      if (fragBuffer.length < 2) return '';
      // Sort by timestamp to prioritize recent fragments
      const sorted = fragBuffer.slice().sort((a, b) => b.ts - a.ts);
      const [b, a] = sorted.slice(0, 2).map(f => f.digits);
      if (!a || !b || a === b) return '';
      const ab=a+b, ba=b+a;
      return (ab.length===10 || ab.length===13) ? ab :
             (ba.length===10 || ba.length===13) ? ba :
             (a.length===10 || a.length===13) ? a :
             (b.length===10 || b.length===13) ? b : '';
    }
  </script>
</head>
<body>
  <!-- Splash -->
  <div id="splash">
    <div class="wrap">
      <img src="img/bagvoyage-icon-192.png" alt="Bagvoyage logo" />
      <h1>Bagvoyage</h1>
    </div>
  </div>

  <!-- Saved ✓ overlay -->
  <div id="savedTick" class="saved-tick" aria-hidden="true">✔</div>

  <div class="app" role="application" aria-label="Bagvoyage">
    <div class="hdr">
      <div class="brand">
        <!-- Simple suitcase + check -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <title>Suitcase with checkmark</title>
          <rect x="5" y="7" width="14" height="12" rx="2" ry="2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M8 13l2.2 2.2L16 9.5" fill="none" stroke="#00cc88" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Bagvoyage</span>
      </div>
      <div class="right">
        <span class="chip"><span id="dbDot" class="dot"></span><span id="dbLabel">DB: checking…</span></span>
        <span class="chip"><span id="camDot" class="dot"></span><span id="camLabel">Camera: idle</span></span>
      </div>
    </div>

    <div id="home" class="main home">
      <div class="stack">
        <button id="btnTag" class="btn primary">Tag — Start scanning</button>
        <button id="btnRetrieve" class="btn ghost">Retrieve — Scan to verify</button>
        <button id="btnManual" class="btn ghost">Manual entry</button>
      </div>
    </div>

    <div id="scan" class="main scan hidden" aria-live="polite">
      <div class="toolbar">
        <div class="title" id="modeTitle">Mode</div>
        <div class="spacer"></div>
        <button id="btnTorch" class="btn ghost" title="Toggle torch">Torch</button>
        <button id="btnStop" class="btn ghost" title="Exit scanning">Exit</button>
      </div>
      <video id="preview" muted playsinline aria-label="Camera feed for barcode scanning"></video>
      <div class="frame">
        <div class="corn tl"></div><div class="corn tr"></div><div class="corn bl"></div><div class="corn br"></div>
        <div class="line"></div>
      </div>
      <div id="sheet" class="sheet" aria-atomic="true" role="alert">
        <div class="row">
          <span id="pill" class="pill">STATE</span>
          <button id="btnContinue" class="btn primary hidden">Continue</button>
        </div>
        <div style="margin:8px 0 6px;font-weight:800;font-size:18px" id="sheetTitle">Result</div>
        <div style="font-family:ui-monospace,Menlo,Consolas,monospace" id="sheetCode"></div>
      </div>
      <!-- optional toast kept for future use -->
      <div id="toast" class="toast">Saved</div>
    </div>
  </div>

  <!-- Manual entry -->
  <dialog id="manualDialog" aria-labelledby="manualTitle">
    <form method="dialog">
      <div id="manualTitle" style="font-weight:800;margin-bottom:8px">Manual entry</div>
      <label for="manualInput" class="sr-only">Enter baggage code</label>
      <input id="manualInput" type="text" placeholder="Enter code" aria-describedby="manualDesc"/>
      <div id="manualDesc" class="sr-only">Enter a 10 or 13-digit baggage code.</div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" value="cancel">Cancel</button>
        <button id="manualApply" class="btn primary" value="ok">Apply</button>
      </div>
    </form>
  </dialog>

  <script>
    // Splash hide
    window.addEventListener('load', () => {
      setTimeout(() => document.getElementById('splash').classList.add('hidden'), 250);
    });

    (function init(){
      if(window.__BAGVOYAGE_LOADED__){ console.warn('Bagvoyage already loaded.'); return; }
      window.__BAGVOYAGE_LOADED__ = true;

      // State
      let isScanning = false, mode = null, currentTrack = null;
      let lastRead = { code:null, ts:0 };
      let scanRaf = null;
      let scanCooldownUntil = 0;
      let isTorchOn = false;

      // Local DB
      const DBKEY = 'bagvoyage_tags';
      const getAll = () => { try{return JSON.parse(localStorage.getItem(DBKEY)||'[]')}catch{return[]} };
      const saveTag = code => { 
        if (!normalizeBaggageCode(code)) return; // Validate format
        const a = getAll();
        if (a.length > 100) a.pop(); // Cap at 100 entries
        a.unshift({code,ts:Date.now()}); 
        try { localStorage.setItem(DBKEY, JSON.stringify(a)); } catch (e) {
          console.error('Storage failed:', e);
          toast('Failed to save tag', 1000);
        }
      };
      const exists  = code => getAll().some(x=>x.code===code);

      // DOM
      const $home = document.getElementById('home');
      const $scan = document.getElementById('scan');
      const $title = document.getElementById('modeTitle');
      const $video = document.getElementById('preview');
      const $sheet = document.getElementById('sheet');
      const $pill = document.getElementById('pill');
      const $sheetTitle = document.getElementById('sheetTitle');
      const $sheetCode = document.getElementById('sheetCode');
      const $btnContinue = document.getElementById('btnContinue');
      const $toast = document.getElementById('toast');
      const $dbDot = document.getElementById('dbDot');
      const $dbLabel = document.getElementById('dbLabel');
      const $camDot = document.getElementById('camDot');
      const $camLabel = document.getElementById('camLabel');
      const $manualDlg = document.getElementById('manualDialog');
      const $manualInput = document.getElementById('manualInput');
      const $savedTick = document.getElementById('savedTick');

      setTimeout(()=>{ $dbDot.className='dot ok'; $dbLabel.textContent='DB: online (local demo)'; }, 300);

      const vibrate = p => { try{ navigator.vibrate && navigator.vibrate(p) }catch{} };
      const toast = (msg, ms=800) => { $toast.textContent=msg; $toast.classList.add('show'); setTimeout(()=>$toast.classList.remove('show'), ms); };

      function openSheet(kind, title, code, wait){
        $pill.className = 'pill ' + (kind==='ok'?'ok':'bad');
        $pill.textContent = kind==='ok' ? 'MATCH' : 'UNMATCHED';
        $sheetTitle.textContent = title; $sheetCode.textContent = code;
        $btnContinue.classList.toggle('hidden', !wait);
        $btnContinue.setAttribute('tabindex', wait ? '0' : '-1'); // Remove from focus when hidden
        $sheet.classList.add('show'); 
        if (!wait) setTimeout(()=> $sheet.classList.remove('show'), 900);
        if (wait) $btnContinue.focus(); // Auto-focus continue button
      }
      function showHome(){ $scan.classList.add('hidden'); $home.classList.remove('hidden'); mode=null; setCamStatus(false); $scan.classList.remove('active'); }
      function showScan(m){ mode=m; $title.textContent = m==='tag'?'Tag — scanning':'Retrieve — scan to verify'; $home.classList.add('hidden'); $scan.classList.remove('hidden'); $scan.classList.add('active'); }
      function setCamStatus(active){ if(active){ $camDot.className='dot ok'; $camLabel.textContent='Camera: active'; } else { $camDot.className='dot'; $camLabel.textContent='Camera: idle'; } }

      function showSavedTick(ms = 900){
        if(!$savedTick) return;
        $savedTick.classList.add('show');
        setTimeout(()=> $savedTick.classList.remove('show'), ms);
      }

      async function setTorch(on){
        if (!currentTrack) return;
        try{
          const caps = currentTrack.getCapabilities?.();
          if (caps?.torch) {
            await currentTrack.applyConstraints({ advanced: [{ torch: !!on }] });
            isTorchOn = on;
            document.getElementById('btnTorch').textContent = isTorchOn ? 'Torch Off' : 'Torch On';
          } else {
            toast('Torch not supported', 1000);
          }
        }catch(e){ toast('Torch control failed', 1000); }
      }

      async function startScan(m){
        if (isScanning) return;
        showScan(m);
        isScanning = true;
        setCamStatus(true);

        // stop any previous track
        if (currentTrack) { try{ currentTrack.stop(); }catch{} currentTrack = null; }

        try{
          // Start camera (works for both native + ZXing paths)
          const constraints = {
            video: {
              facingMode:{ ideal:'environment' },
              width:{ ideal:1280, min:640 }, height:{ ideal:720, min:360 },
              frameRate:{ ideal:30, min:15 }
            },
            audio: false
          };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          $video.srcObject = stream;
          await $video.play().catch(()=>{});
          if ($video.readyState < 2) {
            await new Promise(res => $video.addEventListener('loadedmetadata', res, { once:true }));
          }
          currentTrack = stream.getVideoTracks()[0] || null;

          // Unified handler for decoded strings
          const handleDecode = (raw) => {
            if (!isScanning || !raw) return;
            const digits = extractDigits(raw);
            if (digits) addFragment(digits);
            const assembled = tryAssemble();
            const processed = normalizeBaggageCode(raw) || digits || raw;
            const payload   = assembled || processed;
            if (!payload) return;

            scanCooldownUntil = Date.now() + 500; // brief cooldown
            fragBuffer = [];
            onScan(payload);
          };

          // Prefer native on Android; FORCE ZXing on iOS
          const ua = navigator.userAgent || '';
          const isIOS = /iPad|iPhone|iPod/.test(ua) ||
                        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

          if (!isIOS && 'BarcodeDetector' in window && typeof BarcodeDetector === 'function') {
            let supported = [];
            try { supported = await BarcodeDetector.getSupportedFormats(); } catch {}
            const wanted = ['qr_code','code_128','code_39','itf','ean_13','ean_8','upc_a','pdf417','data_matrix','aztec'];
            const formats = wanted.filter(f => supported.includes(f));

            if (formats.length) {
              const detector = new BarcodeDetector({ formats });
              const loop = async () => {
                if (!isScanning) return;
                if (Date.now() < scanCooldownUntil) { scanRaf = requestAnimationFrame(loop); return; }
                try{
                  const codes = await detector.detect($video);
                  if (codes && codes.length) handleDecode(codes[0].rawValue);
                }catch(e){
                  console.warn('Native detect failed, falling back to ZXing:', e);
                  return fallbackToZXing(handleDecode);
                }
                scanRaf = requestAnimationFrame(loop);
              };
              scanRaf = requestAnimationFrame(loop);
              return; // native path running
            }
          }

          // ZXing on iOS (and as fallback)
          await fallbackToZXing(handleDecode);

        }catch(e){
          console.error('[Bagvoyage] startScan error:', e);
          toast('Camera access failed: ' + e.message, 1500);
          stopScan();
          showHome();
        }

        // ZXing helper
        async function fallbackToZXing(handleDecode){
          const ZXB = window.ZXingBrowser || {};
          const ReaderClass = ZXB.BrowserMultiFormatReader;
          if (!ReaderClass) throw new Error('ZXing library not loaded');
          const reader = new ReaderClass();

          let hints;
          const BF = ZXB.BarcodeFormat, HT = ZXB.DecodeHintType;
          if (BF && HT) {
            const fmts = [BF.ITF,BF.CODE_128,BF.CODE_39,BF.EAN_13,BF.EAN_8,BF.UPC_A,BF.QR_CODE,BF.DATA_MATRIX,BF.PDF_417].filter(Boolean);
            hints = new Map();
            hints.set(HT.TRY_HARDER, true);
            hints.set(HT.POSSIBLE_FORMATS, fmts);
          }

          await reader.decodeFromVideoDevice(
            undefined,
            $video,
            (result, err) => {
              if (!isScanning || !result) return;
              if (Date.now() < scanCooldownUntil) return;
              handleDecode(result.getText());
            },
            hints
          );

          const s = $video.srcObject;
          currentTrack = s?.getVideoTracks?.[0] || currentTrack;
          window.__bagvoyage_reader__ = reader;
        }
      }

      function stopScan(){
        if(!isScanning) return;
        isScanning = false;
        if (scanRaf) { cancelAnimationFrame(scanRaf); scanRaf = null; }
        // turn torch off first, then stop track & reset reader
        setTorch(false).finally(()=>{
          try{ window.__bagvoyage_reader__?.reset?.(); }catch{}
          if (currentTrack) { try{ currentTrack.stop(); }catch{} currentTrack = null; }
          setCamStatus(false);
          $scan.classList.remove('active');
        });
      }

      function onScan(text){
        const code = (text||'').trim();
        if(!code) return;
        const now = Date.now();
        if(code===lastRead.code && (now-lastRead.ts)<900) return; // de-dupe
        lastRead = { code, ts: now };

        if(mode==='tag'){
          saveTag(code);
          vibrate(30);
          showSavedTick(); // ✓ overlay instead of toast
        }else if(mode==='retrieve'){
          const ok = exists(code);
          if(ok){ vibrate([40,60,40]); stopScan(); openSheet('ok','MATCH',code,true); }
          else { vibrate([30,40,30]); openSheet('bad','UNMATCHED',code,false); }
        }
      }

      // Torch toggle
      document.getElementById('btnTorch').addEventListener('click', async ()=>{
        setTorch(!isTorchOn);
      });

      // Continue & Exit
      $btnContinue.addEventListener('click', ()=>{ $sheet.classList.remove('show'); startScan('retrieve'); });
      document.getElementById('btnStop').addEventListener('click', async ()=>{
        await setTorch(false);
        stopScan();
        showHome();
      });

      // Page/tab leave: ensure torch is off and camera stops (iOS quirk)
      window.addEventListener('pagehide', () => { setTorch(false).finally(stopScan); });
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) { setTorch(false).finally(stopScan); }
        else if (mode) { startScan(mode); }
      });

      // Home buttons
      document.getElementById('btnTag').addEventListener('click', ()=> startScan('tag'));
      document.getElementById('btnRetrieve').addEventListener('click', ()=> startScan('retrieve'));

      // Manual entry
      document.getElementById('btnManual').addEventListener('click', ()=> { $manualInput.value=''; $manualDlg.showModal(); });
      document.getElementById('manualApply').addEventListener('click', (e)=>{
        e.preventDefault();
        const v = ($manualInput.value||'').trim(); if(!v) return;
        if(!mode || mode==='tag'){ saveTag(v); showSavedTick(); }
        else { exists(v) ? (stopScan(), openSheet('ok','MATCH',v,true)) : openSheet('bad','UNMATCHED',v,false); }
        $manualDlg.close();
      });
    })();
  </script>
</body>
</html>
