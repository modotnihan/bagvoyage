<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bagvoyage</title>

  <!-- Icons / PWA -->
  <link rel="icon" type="image/png" sizes="32x32" href="img/bagvoyage-icon-32.png" />
  <link rel="apple-touch-icon" href="img/bagvoyage-icon-180.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Theme Colors -->
  <meta name="theme-color" content="#1aa3ff" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Fonts & ZXing -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <!-- App CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Splash -->
  <div id="splash">
    <div class="wrap">
      <img src="img/bagvoyage-icon-192.png" alt="Bagvoyage logo" />
      <h1>Bagvoyage</h1>
    </div>
  </div>

  <!-- Pull-to-refresh indicator -->
  <div id="ptrIndicator" aria-hidden="true">↓ Release to refresh</div>

  <!-- Saved ✓ overlay -->
  <div id="savedTick" class="saved-tick" aria-hidden="true">✔</div>

  <!-- Hidden input for HID barcode scanners (keyboard wedge) -->
  <input id="scannerInput" autocomplete="off" inputmode="none" aria-hidden="true"
         style="position:absolute;left:-9999px;opacity:0" />

  <div class="app" role="application" aria-label="Bagvoyage">
    <div class="hdr">
      <div class="brand">
        <!-- Simple suitcase + check -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <title>Suitcase with checkmark</title>
          <rect x="5" y="7" width="14" height="12" rx="2" ry="2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" fill="none" stroke="#1aa3ff" stroke-width="2"/>
          <path d="M8 13l2.2 2.2L16 9.5" fill="none" stroke="#00cc88" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Bagvoyage</span>
      </div>
      <div class="right">
        <span class="chip"><span id="dbDot" class="dot"></span><span id="dbLabel">DB: checking…</span></span>
        <span class="chip"><span id="camDot" class="dot"></span><span id="camLabel">Camera: idle</span></span>
      </div>
    </div>

    <div id="home" class="main home">
      <div class="stack">
        <button id="btnTag" class="btn primary">Tag — Start scanning</button>
        <button id="btnRetrieve" class="btn ghost">Retrieve — Scan to verify</button>
        <button id="btnManual" class="btn ghost">Manual entry</button>
      </div>
    </div>

    <div id="scan" class="main scan hidden" aria-live="polite">
      <div class="toolbar">
        <div class="title" id="modeTitle">Mode</div>
        <div class="spacer"></div>
        <button id="btnTorch" class="btn ghost" title="Toggle torch" aria-pressed="false">Torch</button>
        <button id="btnStop" class="btn ghost" title="Exit scanning">Exit</button>
      </div>

      <video id="preview" muted playsinline webkit-playsinline
             aria-label="Camera feed for barcode scanning"></video>

      <div class="frame" aria-hidden="true">
        <div class="corn tl"></div><div class="corn tr"></div><div class="corn bl"></div><div class="corn br"></div>
        <div class="line"></div>
      </div>

      <!-- Result sheet (singleton) -->
      <div id="sheet" class="sheet" aria-atomic="true" role="alert">
        <div class="row">
          <span id="pill" class="pill">STATE</span>
          <button id="btnContinue" class="btn primary hidden">Continue</button>
        </div>
        <div id="sheetTitle" class="sheet-title">Result</div>
        <div id="sheetCode" class="sheet-code" aria-live="polite"></div>
      </div>

      <!-- toast (optional) -->
      <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>
    </div>
  </div>

  <!-- Manual entry -->
  <dialog id="manualDialog" aria-labelledby="manualTitle">
    <form method="dialog">
      <div id="manualTitle" class="modal-title">Manual entry</div>
      <label for="manualInput" class="sr-only">Enter baggage code</label>
      <input id="manualInput" type="text" placeholder="Enter code" aria-describedby="manualDesc"/>
      <div id="manualDesc" class="sr-only">Enter a 10 or 13-digit baggage code.</div>
      <div class="modal-actions">
        <button class="btn ghost" value="cancel">Cancel</button>
        <button id="manualApply" class="btn primary" value="ok">Apply</button>
      </div>
    </form>
  </dialog>

  <script>
    // --- Service Worker (keep your existing file as-is) ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('SW registered'))
        .catch(err => console.warn('SW registration failed', err));
    }

    // --- Splash hide ---
    window.addEventListener('load', () => {
      setTimeout(() => document.getElementById('splash').classList.add('hidden'), 250);
    });

    // ---------- Helpers ----------
    function extractDigits(s){ return (s && s.match(/\d+/g)) ? s.match(/\d+/g).join('') : ''; }
    function normalizeBaggageCode(s){
      const d = extractDigits(s);
      return (d.length === 10 || d.length === 13) ? d : '';
    }

    // Split-label assembly (combine two Code128 halves within 1s)
    const FRAG_WINDOW_MS = 1000;
    let fragBuffer = []; // {digits, ts}
    function addFragment(d){
      const now=Date.now();
      fragBuffer.push({digits:d, ts:now});
      // limit + de-dupe (recent)
      fragBuffer = fragBuffer.slice(-10).filter((f,i,a)=> now-f.ts<=FRAG_WINDOW_MS && (i===0 || f.digits!==a[i-1].digits));
    }
    function tryAssemble(){
      if (fragBuffer.length < 2) return '';
      const sorted = fragBuffer.slice().sort((a, b) => b.ts - a.ts);
      const [b, a] = sorted.slice(0, 2).map(f => f.digits);
      if (!a || !b || a === b) return '';
      const ab=a+b, ba=b+a;
      return (ab.length===10 || ab.length===13) ? ab :
             (ba.length===10 || ba.length===13) ? ba :
             (a.length===10 || a.length===13) ? a :
             (b.length===10 || b.length===13) ? b : '';
    }

    (function init(){
      if(window.__BAGVOYAGE_LOADED__){ console.warn('Bagvoyage already loaded.'); return; }
      window.__BAGVOYAGE_LOADED__ = true;

      // State
      let isScanning = false, mode = null, currentTrack = null;
      let lastRead = { code:null, ts:0 };
      let scanCooldownUntil = 0;
      let isTorchOn = false;
      let isContinuing = false; // guard for Continue

      // Local DB
      const DBKEY = 'bagvoyage_tags';
      const getAll = () => { try{return JSON.parse(localStorage.getItem(DBKEY)||'[]')}catch{return[]} };
      const saveTag = code => {
        const n = normalizeBaggageCode(code);
        if (!n) return;
        const a = getAll();
        if (a.length > 100) a.pop();
        a.unshift({code:n,ts:Date.now()});
        try { localStorage.setItem(DBKEY, JSON.stringify(a)); } catch (e) {
          console.error('Storage failed:', e);
          toast('Failed to save tag', 1000);
        }
      };
      const exists  = code => getAll().some(x=>x.code===normalizeBaggageCode(code));

      // DOM
      const $home = document.getElementById('home');
      const $scan = document.getElementById('scan');
      const $title = document.getElementById('modeTitle');
      const $video = document.getElementById('preview');
      const $sheet = document.getElementById('sheet');
      const $pill = document.getElementById('pill');
      const $sheetTitle = document.getElementById('sheetTitle');
      const $sheetCode = document.getElementById('sheetCode');
      const $btnContinue = document.getElementById('btnContinue');
      const $toast = document.getElementById('toast');
      const $dbDot = document.getElementById('dbDot');
      const $dbLabel = document.getElementById('dbLabel');
      const $camDot = document.getElementById('camDot');
      const $camLabel = document.getElementById('camLabel');
      const $manualDlg = document.getElementById('manualDialog');
      const $manualInput = document.getElementById('manualInput');
      const $savedTick = document.getElementById('savedTick');
      const $scannerInput = document.getElementById('scannerInput');
      const $ptr = document.getElementById('ptrIndicator');

      // Status
      setTimeout(()=>{ $dbDot.className='dot ok'; $dbLabel.textContent='DB: online (local)'; }, 300);

      const vibrate = p => { try{ navigator.vibrate && navigator.vibrate(p) }catch{} };
      const toast = (msg, ms=800) => { $toast.textContent=msg; $toast.classList.add('show'); setTimeout(()=>$toast.classList.remove('show'), ms); };

      // ---- Result sheet (singleton) ----
      function openSheet(kind, title, code, wait){
        // Reset/ensure single active listener on Continue
        $btnContinue.replaceWith($btnContinue.cloneNode(true));
        const freshBtn = document.getElementById('btnContinue');
        freshBtn.addEventListener('click', onContinue, { once:true });

        $pill.className = 'pill ' + (kind==='ok'?'ok':'bad');
        $pill.textContent = kind==='ok' ? 'MATCH' : 'UNMATCHED';
        $sheetTitle.textContent = title;
        $sheetCode.textContent = code;

        freshBtn.classList.toggle('hidden', !wait);
        freshBtn.setAttribute('tabindex', wait ? '0' : '-1');

        $sheet.classList.add('show');
        if (!wait) setTimeout(()=> $sheet.classList.remove('show'), 900);
        if (wait) freshBtn.focus();
      }

      function hideSheet(){
        $sheet.classList.remove('show');
        // also reset Continue guard
        isContinuing = false;
      }

      function showHome(){
        $scan.classList.add('hidden');
        $home.classList.remove('hidden');
        mode=null;
        setCamStatus(false);
        $scan.classList.remove('active');
        hideSheet();
      }

      function showScan(m){
        mode=m;
        $title.textContent = m==='tag'?'Tag — scanning':'Retrieve — scan to verify';
        $home.classList.add('hidden');
        $scan.classList.remove('hidden');
        $scan.classList.add('active');
        // keep the hidden input focused for HID scanners
        focusScannerInput();
      }

      function setCamStatus(active){
        if(active){ $camDot.className='dot ok'; $camLabel.textContent='Camera: active'; }
        else { $camDot.className='dot'; $camLabel.textContent='Camera: idle'; }
      }

      function showSavedTick(ms = 900){
        $savedTick.classList.add('show');
        setTimeout(()=> $savedTick.classList.remove('show'), ms);
      }

      // ---- Torch control (ImageCapture preferred) ----
      async function setTorch(on){
        if (!currentTrack) return;
        try{
          if ('ImageCapture' in window && currentTrack.kind === 'video') {
            const ic = new ImageCapture(currentTrack);
            await ic.setOptions({ torch: !!on });
            isTorchOn = !!on;
          } else if (currentTrack.applyConstraints) {
            const caps = currentTrack.getCapabilities?.();
            if (caps?.torch) {
              await currentTrack.applyConstraints({ advanced: [{ torch: !!on }] });
              isTorchOn = !!on;
            }
          }
          document.getElementById('btnTorch').textContent = isTorchOn ? 'Torch Off' : 'Torch On';
          document.getElementById('btnTorch').setAttribute('aria-pressed', String(isTorchOn));
        }catch(e){
          // silently ignore on unsupported devices
        }
      }

      // ---- Camera start/stop ----
      async function startScan(m){
        if (isScanning) return;
        showScan(m);
        isScanning = true;
        setCamStatus(true);

        // Stop any previous
        await stopCamera();

        try{
          const constraints = {
            video: {
              facingMode:{ ideal:'environment' },
              width:{ ideal:1280, min:960 },
              height:{ ideal:720,  min:540 },
              aspectRatio: { ideal: 16/9 },
              frameRate:{ ideal:30, min:15 }
            },
            audio: false
          };
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          $video.srcObject = stream;
          await $video.play().catch(()=>{});
          if ($video.readyState < 2) {
            await new Promise(res => $video.addEventListener('loadedmetadata', res, { once:true }));
          }
          currentTrack = stream.getVideoTracks()[0] || null;

          // ZXing (browser)
          const ZXB = window.ZXingBrowser || {};
          const ReaderClass = ZXB.BrowserMultiFormatReader;
          if (!ReaderClass) throw new Error('ZXing library not loaded');

          const reader = new ReaderClass();
          const BF = ZXB.BarcodeFormat, HT = ZXB.DecodeHintType;
          let hints;
          if (BF && HT) {
            const fmts = [BF.ITF,BF.CODE_128,BF.CODE_39,BF.EAN_13,BF.EAN_8,BF.UPC_A,BF.QR_CODE,BF.DATA_MATRIX,BF.PDF_417].filter(Boolean);
            hints = new Map();
            hints.set(HT.TRY_HARDER, true);
            hints.set(HT.POSSIBLE_FORMATS, fmts);
          }

          await reader.decodeFromVideoDevice(
            undefined,
            $video,
            (result, err) => {
              if (!isScanning || !result) return;
              if (Date.now() < scanCooldownUntil) return;

              const raw = result.getText();
              if (!raw) return;

              const digits = extractDigits(raw);
              if (digits) addFragment(digits);
              const assembled = tryAssemble();
              const processed = normalizeBaggageCode(raw) || digits || raw;
              const payload   = assembled || processed;
              if (!payload) return;

              scanCooldownUntil = Date.now() + 500;
              fragBuffer = [];
              onScan(payload);
            },
            hints
          );

          window.__bagvoyage_reader__ = reader;
        }catch(e){
          console.error('[Bagvoyage] startScan error:', e);
          toast('Camera access failed: ' + (e?.message||e), 1500);
          await stopCamera();
          showHome();
        }
      }

      async function stopCamera(){
        try{
          await setTorch(false); // turn off torch first on iOS
        }catch{}
        try{
          window.__bagvoyage_reader__?.reset?.();
        }catch{}
        const stream = $video.srcObject;
        if (stream) {
          const [track] = stream.getVideoTracks();
          try{ track && track.stop(); }catch{}
        }
        $video.pause();
        $video.srcObject = null;
        currentTrack = null;
        setCamStatus(false);
      }

      function stopScan(){
        if(!isScanning) return;
        isScanning = false;
        hideSheet();
        stopCamera();
      }

      // ---- Scan handler ----
      function onScan(text){
        const code = (text||'').trim();
        if(!code) return;
        const now = Date.now();
        if(code===lastRead.code && (now-lastRead.ts)<900) return; // de-dupe
        lastRead = { code, ts: now };

        if(mode==='tag'){
          saveTag(code);
          vibrate(30);
          showSavedTick();
        }else if(mode==='retrieve'){
          const ok = exists(code);
          if(ok){
            vibrate([40,60,40]);
            stopCamera(); // pause camera while showing result
            openSheet('ok','MATCH',code,true);
          } else {
            vibrate([30,40,30]);
            openSheet('bad','UNMATCHED',code,false);
          }
        }
      }

      // ---- Continue flow (guarded) ----
      async function onContinue(e){
        e?.preventDefault?.();
        if (isContinuing) return;
        isContinuing = true;
        try{
          hideSheet();
          await stopCamera();         // ensure clean state (and torch off)
          if (mode !== 'retrieve') mode = 'retrieve';
          await startScan('retrieve'); // resume verify mode
        }catch(err){
          console.error('Continue failed', err);
        }finally{
          isContinuing = false;
        }
      }

      // ---- Torch toggle ----
      document.getElementById('btnTorch').addEventListener('click', async ()=>{
        await setTorch(!isTorchOn);
      });

      // ---- Exit ----
      document.getElementById('btnStop').addEventListener('click', async ()=>{
        await stopScan();
        showHome();
      });

      // ---- Page/tab lifecycle (iOS safety) ----
      window.addEventListener('pagehide', () => { stopScan(); });
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) stopScan();
        else if (mode) startScan(mode);
      });

      // ---- Home buttons ----
      document.getElementById('btnTag').addEventListener('click', ()=> startScan('tag'));
      document.getElementById('btnRetrieve').addEventListener('click', ()=> startScan('retrieve'));

      // ---- Manual entry ----
      document.getElementById('btnManual').addEventListener('click', ()=>{
        $manualInput.value='';
        $manualDlg.showModal();
      });
      document.getElementById('manualApply').addEventListener('click', (e)=>{
        e.preventDefault();
        const v = ($manualInput.value||'').trim();
        if(!v) return;
        if(!mode || mode==='tag'){ saveTag(v); showSavedTick(); }
        else { exists(v) ? (stopCamera(), openSheet('ok','MATCH',v,true)) : openSheet('bad','UNMATCHED',v,false); }
        $manualDlg.close();
      });

      // ---- HID scanner support (keyboard wedge) ----
      function focusScannerInput(){
        const el = $scannerInput;
        if (document.activeElement !== el) el.focus();
      }
      window.addEventListener('click', focusScannerInput);
      window.addEventListener('keydown', focusScannerInput);

      // Treat Enter as end-of-scan; buffer fallback if no Enter suffix
      let burstTimer;
      const BURST_IDLE_MS = 60;
      $scannerInput.addEventListener('keydown', (e)=>{
        clearTimeout(burstTimer);
        if (e.key === 'Enter') {
          const code = $scannerInput.value.trim();
          $scannerInput.value = '';
          if (code) onScan(code);
          e.preventDefault();
        } else {
          burstTimer = setTimeout(()=>{
            const code = $scannerInput.value.trim();
            if (code.length >= 8) onScan(code);
            $scannerInput.value = '';
          }, BURST_IDLE_MS);
        }
      });

      // ---- Pull to refresh (in-app) ----
      (function enablePullToRefresh(){
        const THRESHOLD = 70;
        let startY = 0, pulling = false, activated = false;

        window.addEventListener('touchstart', (e) => {
          if (document.scrollingElement.scrollTop === 0) {
            startY = e.touches[0].clientY;
            pulling = true; activated = false;
          } else pulling = false;
        }, { passive: true });

        window.addEventListener('touchmove', (e) => {
          if (!pulling) return;
          const dy = e.touches[0].clientY - startY;
          if (dy > 0) {
            if (dy > THRESHOLD && !activated) {
              $ptr.classList.add('active');
              activated = true;
            } else if (dy <= THRESHOLD && activated) {
              $ptr.classList.remove('active');
              activated = false;
            }
          }
        }, { passive: true });

        window.addEventListener('touchend', () => {
          if (pulling && activated) {
            $ptr.classList.remove('active');
            setTimeout(() => window.location.reload(), 60);
          } else {
            $ptr.classList.remove('active');
          }
          pulling = false;
        });
      })();
    })();
  </script>
</body>
</html>
